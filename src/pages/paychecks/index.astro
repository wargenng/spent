---
import Layout from "@/layouts/Layout.astro";
import { db } from "astro:db";
import { getUserPaychecks } from "@/service/queries";
import PaycheckEntryButton from "@/components/paycheckentry/components/paycheckentrybutton";
import { Transactions, eq } from "astro:db";

const userId = String(Astro.locals.auth().userId);
if (!userId) {
    return;
}

const paychecks = await getUserPaychecks(userId);
const allTransactions = await db
    .select()
    .from(Transactions)
    .where(eq(Transactions.userId, userId));

const transactionsByPaycheck = new Map<number, typeof allTransactions>();
allTransactions.forEach((transaction) => {
    const paycheckId = transaction.paycheckId;
    if (!transactionsByPaycheck.has(paycheckId)) {
        transactionsByPaycheck.set(paycheckId, []);
    }
    transactionsByPaycheck.get(paycheckId)!.push(transaction);
});
---

<Layout title="Paychecks">
    <div class="space-y-8 w-full flex items-center justify-center flex-col">
        <div class="w-full flex flex-col gap-6">
            {
                paychecks.length === 0 ? (
                    <div class="flex flex-col gap-4 w-full items-center py-12">
                        <p class="text-gray-500 dark:text-gray-400 text-lg">
                            No paychecks yet
                        </p>
                        <PaycheckEntryButton
                            userId={userId}
                            hasCards={true}
                            client:load
                        />
                    </div>
                ) : (
                    <div class="flex flex-col gap-0 w-full">
                        {paychecks.map((paycheck, index) => {
                            const transactions =
                                transactionsByPaycheck.get(paycheck.id) || [];
                            const total = transactions.reduce(
                                (sum, transaction) => sum + transaction.amount,
                                0
                            );
                            const formatedTotal =
                                (total < 0 ? "" : "+") +
                                total.toLocaleString("en-US", {
                                    style: "currency",
                                    currency: "USD",
                                });
                            const isLast = index === paychecks.length - 1;
                            return (
                                <a
                                    href={`/paychecks/${paycheck.id}`}
                                    class={`w-full p-4 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors cursor-pointer border-b border-gray-400 dark:border-gray-500 ${
                                        isLast ? "" : "pb-4 mb-4"
                                    }`}
                                >
                                    <div class="flex flex-col gap-2 items-start flex-1 text-left">
                                        <div class="flex justify-between w-full items-center">
                                            <h2 class="text-base lg:text-xl font-bold text-gray-900 dark:text-white m-0 text-left">
                                                {paycheck.title}
                                            </h2>
                                            <div class="flex items-center gap-2">
                                                <h3 class="text-base lg:text-xl font-bold text-gray-900 dark:text-white m-0 text-right">
                                                    {formatedTotal}
                                                </h3>
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    width="20"
                                                    height="20"
                                                    viewBox="0 0 24 24"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    stroke-width="2"
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    class="text-gray-400 dark:text-gray-500"
                                                >
                                                    <path d="m9 18 6-6-6-6" />
                                                </svg>
                                            </div>
                                        </div>
                                        <p class="text-xs lg:text-sm text-gray-600 dark:text-gray-400 m-0 text-left">
                                            {new Date(
                                                paycheck.startDate
                                            ).toLocaleDateString("en-US", {
                                                month: "2-digit",
                                                day: "2-digit",
                                            })}{" "}
                                            -{" "}
                                            {new Date(
                                                paycheck.endDate
                                            ).toLocaleDateString("en-US", {
                                                month: "2-digit",
                                                day: "2-digit",
                                                year: "numeric",
                                            })}
                                        </p>
                                    </div>
                                </a>
                            );
                        })}
                    </div>
                )
            }
        </div>
    </div>
</Layout>
